<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Declare Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
  <meta content="Themesdesign" name="author" />
  <!-- App favicon -->
  <!-- <link rel="shortcut icon" href="./assets/images/favicon.ico" /> -->
  <link rel="icon" href="./assets/images/krinikIn_Logo.svg" type="image/x-icon">

  <!-- DataTables -->
  <link href="./assets/libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
  <link href="./assets/libs/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css" rel="stylesheet"
    type="text/css" />

  <!-- Responsive datatable examples -->
  <link href="./assets/libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css" rel="stylesheet"
    type="text/css" />

  <!-- datepicker -->
  <link href="./assets/libs/air-datepicker/air-datepicker.css" rel="stylesheet" type="text/css" />

  <!-- jvectormap -->
  <!-- <link href="./assets/libs/jqvmap/jqvmap.min.css" rel="stylesheet" /> -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />

  <!-- Bootstrap Css -->
  <link href="./assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <!-- Icons Css -->
  <link href="./assets/css/icons.min.css" rel="stylesheet" type="text/css" />
  <!-- App Css-->
  <link href="./assets/css/app.css" rel="stylesheet" type="text/css" />
</head>
<style>
  td {
    vertical-align: middle;
  }

  .responsive-td input {
    margin-top: 5px;
    margin-bottom: 5px;
    width: 46%;
  }

  @media (max-width: 600px) {
    .responsive-td {
      width: 100%;
      flex-direction: column;
      align-items: stretch;
    }

    .responsive-td input {
      width: 100%;
    }
  }
</style>

<body data-topbar="colored">
  <!-- Begin page -->
  <div id="layout-wrapper">
    <header id="page-topbar" class="">
      <div class="navbar-header ">
        <div class="d-flex ">
          <!-- LOGO -->
          <div class="navbar-brand-box">
            <a href="./dashboard.html" class="logo logo-dark">
              <span class="logo-sm">
                
                <img src="./assets/images/krinikIn_Logo.svg" alt="" />
              </span>
              <span class="logo-lg">
              
                <img src="./assets/images/krinikIn_Logo.svg" alt=""  />
              </span>
            </a>

            <a href="index.html" class="logo logo-light ">
              <span class="logo-sm">
             
                <img src="./assets/images/krinikIn_Logo.svg" alt=""  />
              </span>
              <span class="logo-lg">
                
                <img src="./assets/images/krinikIn_Logo.svg" alt="" />
              </span>
            </a>
          </div>

          <button type="button" class="btn btn-sm px-3 font-size-24 header-item waves-effect " id="vertical-menu-btn">
            <i class="mdi mdi-backburger "></i>
          </button>

          <!-- App Search-->
          <!-- <form class="app-search d-none d-lg-block">
                            <div class="position-relative mt-3">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="mdi mdi-magnify"></span>
                            </div>
                        </form> -->
        </div>

        <div class="  d-flex justify-content-center gap-4 time_show1">
          <div class="dropdown d-flex justify-content-end ms-2  " id="enterotpdiv">
            <!-- <button id="showotppage" type="button" class="btn btn-primary2  waves-effect" 
             >Enter OTP
            </button> -->
            
          </div>
        
          <div class="dropdown   dblock">
            <div id="time_show" class="btn-primary2  px-3">
            </div>
          </div>

          
        </div>
        
      </div>
    </header>

     <!-- ========== Left Sidebar Start ========== -->
     <div class="vertical-menu ">
      <div data-simplebar class="h-100 ">
        <!--- Sidemenu -->
        <div id="sidebar-menu" class="">
          <!-- Left Menu Start -->
          <ul class="metismenu list-unstyled " id="side-menu">
            <li class="menu-title">Menu</li>

            <li>
              <a href="./dashboard.html" class="waves-effect">
                <div class=" icons-sm icon-set">
                  <span class="material-symbols-outlined icon-margin">
                    dashboard
                    </span>
               
                <span>Dashboard</span>
                </div>
              </a>
            </li>

            <li>
              <a href="./user.html" class="waves-effect">
                <div class="icons-sm icon-set">
                  <span class="material-symbols-outlined icon-margin">
                    person
                    </span>
               
                <span>User</span>
              </div>
              </a>
            </li>

            <li>
              <a href="javascript: void(0);" class=" ">
                <div class="icons-sm icon-set ">
                  <span class="material-symbols-outlined icon-margin">
                    sports_cricket
                    </span>                    
                    <span class="has-arrow waves-effect ">Sports Configuration</span>
                                    
                  </div> 
                  
                </a>

              <ul class="sub-menu" aria-expanded="false">
                <li><a href="./manage-league.html">Manage Leagues</a></li>
                <li><a href="./manage-team.html">Manage Teams</a></li>
                <li><a href="./manage-player.html">Manage Players</a></li>
              </ul>
            </li>
            
            <li>
              <a href="javascript: void(0);" class=" ">
                <div class="icons-sm icon-set ">
                  <span class="material-symbols-outlined icon-margin">
                    crossword
                    </span>                   
                    <span class="has-arrow has-arrow1 waves-effect ">Manage Contest</span>
                                    
                  </div> 
                  
                </a>

              <ul class="sub-menu" aria-expanded="false">
                <li><a href="./manage-match.html">Manage Match</a></li>
                <li><a href="./manage-pool.html">Manage Pools</a></li>
              </ul>
            </li>

            <li class="otp-exempt" style="display:none">
              <a href="javascript: void(0);" class=" ">
                <div class="icons-sm icon-set ">
                  <span class="material-symbols-outlined icon-margin">
                    receipt_long
                    </span>                 
                    <span class="has-arrow has-arrow2 waves-effect ">Transactions</span>
                                    
                  </div> 
                  
                </a>

              <ul class="sub-menu" aria-expanded="false">
                <li><a href="./all-transaction.html">All Transaction</a></li>
                <li><a href="./wallet-transaction.html">Wallet Transaction</a></li>
                <li><a href="./game-transaction.html">Game Transaction</a></li>
              </ul>
            </li>

            <li class="otp-exempt" style="display:none">
              <a href="./account-setting.html" class="waves-effect">
                <div class="icons-sm icon-set ">
                  <span class="material-symbols-outlined icon-margin">
                    settings
                    </span>
                    <span>Account Setting</span>
                </div>
              </a>
            </li>
            <li class="otp-exempt" style="display:none">
              <a href="./advertise.html" class="waves-effect">
                <div class="icons-sm icon-set ">
                  <span class="material-symbols-outlined icon-margin">
                    ad
                    </span>
                    <span>Advertise</span>
                </div>
              </a>
            </li>
            <li>
              <a href="./kyc.html" class="waves-effect">
                <div class="icons-sm icon-set">
                  <span class="material-symbols-outlined icon-margin">
                    person
                    </span>
               
                <span>KYC</span>
              </div>
              </a>
            </li>

            <li>
              <a href="" class="waves-effect " id="logoutButton">
                <div class=" icons-sm icon-set ">
                  <span class="material-symbols-outlined icon-margin ">
                    logout
                    </span>
                    <span class="">Logout</span>
                </div>
              </a>
            </li>

          
                    </ul>
        </div>
        <!-- Sidebar -->
      </div>
    </div>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
      <div class="page-content">
        <!-- Page-Title -->
        <div class="page-title-box">
          <div class="container-fluid">
            <div class="row align-items-center">

              <div>
                <h4 class="page-title mb-1">Declare Result</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="page-content-wrapper">
          <div class="container-fluid">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">

                    <div class="row">

                      <div class="table-rep-plugin">
                        <div class="table-responsive mb-0 table table-scroll" data-pattern="priority-columns"
                          id="table-scrolling">
                          <table id="matchTable" class="table table-striped text-center align-items-center">
                            <thead class="align-items-center">
                              <tr>
                                <th data-priority="">No.</th>
                                <th data-priority="" class="sortable" data-column="team_name" colspan="2">All Players Name

                                </th>
                                <th data-priority="" colspan="2">
                                  Team Name
                                </th>
                                <th data-priority="">
                                  Run Enter
                                </th>
                              </tr>
                            </thead>
                            <tbody>
<!-- 
                              <tr>
                                <td>1</td>
                                <td> Rohit Sharma</td>
                                <td>INDIA</td>
                                <td class="responsive-td">
                                  <input type="text" placeholder="Enter Run" class="p-2 text-center">
                                </td>
                              </tr>

                              <tr>
                                <td>1</td>
                                <td> Rohit Sharma</td>
                                <td>INDIA</td>
                                <td class="responsive-td">
                                  <input type="text" placeholder="Enter Run" class="p-2  text-center">
                                </td>
                              </tr>
                              <tr>
                                <td>1</td>
                                <td> Rohit Sharma</td>
                                <td>INDIA</td>
                                <td class="responsive-td">
                                  <input type="text" placeholder="Enter Run" class="p-2 text-center">
                                </td>
                              </tr>
                              <tr>
                                <td>1</td>
                                <td> Rohit Sharma</td>
                                <td>INDIA</td>
                                <td class="responsive-td">
                                  <input type="text" placeholder="Enter Run" class="p-2 text-center">
                                </td>
                              </tr> -->





                          </table>

                        </div>
                        <div id="noDataFound" style="display:none;" class="no-data-div">
                          <img src="./assets/images/no-data.jpg" alt="No Data Found">
                        </div>
                      </div>

                    </div>
                    <div class="row pagi align-items-baseline" id="pagination" style="display:none">
                      <div class="col-sm-12 col-md-5">
                        <div class="dataTables_info" id="datatable_info" role="status" aria-live="polite">
                          Showing 1 to 10 of 57 leagues
                        </div>
                      </div>
                      <div class="col-sm-12 col-md-7">
                        <div class="dataTables_paginate paging_simple_numbers pagination index_buttons justify-content-end"
                          id="datatable_paginate">
                          <ul class="pagination-list d-flex list-unstyled"></ul>
                        </div>
                      </div>
                    </div>
                    <div class="row  ">
                      <div class="col-lg-12 d-flex justify-content-center">
                        <div class="mt-4">
                          <button class="btn btn-primary px-4 py-2" type="submit" id="submitButton">Submit</button>
                        </div>
                      </div>
                    </div>
                    <!-- </div> -->
                  </div>
                </div>
              </div>
              <!-- end col -->
            </div>
            <!-- end row -->
          </div>

        </div>
        <!-- end row -->
      </div>
      <!-- container-fluid -->
    </div>
    <!-- end page-content-wrapper -->
  </div>
  <!-- End Page-content -->

  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-6">2020 © Xoric.</div>
        <div class="col-sm-6">
          <div class="text-sm-end d-none d-sm-block">
            Crafted with <i class="mdi mdi-heart text-danger"></i> by
            Themesdesign
          </div>
        </div>
      </div>
    </div>
  </footer>
  </div>
  <!-- end main content-->
  </div>
  <!-- END layout-wrapper -->

  

  <!-- JAVASCRIPT -->
  <script src="./assets/libs/jquery/jquery.min.js"></script>
  <script src="./assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="./assets/libs/metismenu/metisMenu.min.js"></script>
  <script src="./assets/libs/simplebar/simplebar.min.js"></script>
  <script src="./assets/libs/node-waves/waves.min.js"></script>

  <script src="https://unicons.iconscout.com/release/v2.0.1/script/monochrome/bundle.js"></script>

  <!-- Required datatable js -->
  <script src="./assets/libs/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="./assets/libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>
  <!-- Buttons examples -->
  <script src="./assets/libs/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
  <script src="./assets/libs/datatables.net-buttons-bs4/js/buttons.bootstrap4.min.js"></script>
  <script src="./assets/libs/jszip/jszip.min.js"></script>
  <!-- <script src="./assets/libs/pdfmake/build/pdfmake.min.js"></script> -->
  <!-- <script src="./assets/libs/pdfmake/build/vfs_fonts.js"></script> -->
  <script src="./assets/libs/datatables.net-buttons/js/buttons.html5.min.js"></script>
  <script src="./assets/libs/datatables.net-buttons/js/buttons.print.min.js"></script>
  <script src="./assets/libs/datatables.net-buttons/js/buttons.colVis.min.js"></script>
  <!-- Responsive examples -->
  <script src="./assets/libs/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
  <script src="./assets/libs/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js"></script>

  <!-- datepicker -->
  <script src="./assets/libs/air-datepicker/air-datepicker.js"></script>
  <script src="./assets/libs/air-datepicker/air-datepicker.js"></script>

  <!-- apexcharts -->
  <!-- <script src="./assets/libs/apexcharts/apexcharts.min.js"></script> -->

  <script src="./assets/libs/jquery-knob/jquery.knob.min.js"></script>

  <!-- Jq vector map -->
  <!-- <script src="./assets/libs/jqvmap/jquery.vmap.min.js"></script> -->
  <!-- <script src="./assets/libs/jqvmap/maps/jquery.vmap.usa.js"></script> -->

  <script src="./assets/js/pages/dashboard.init.js"></script>

  <script src="./assets/js/app.js"></script>

<script>
  
var rankList = [];
var array = [];
var array_length = 0;
var table_size = 10;
var start_index = 1;
var end_index = 0;
var current_index = 1;
var max_index = 0;
var otpApi 
var otpApi2 
let totaldataleague = document.querySelector("#total-league-data");
let otpAdd = document.querySelector("#add-new-btn");
const urlParams = new URLSearchParams(window.location.search);
let id = urlParams.get('id');
let NumberId = Number(id);
console.log(typeof NumberId, NumberId, "NumberId");
let teamData
let matchName
let userplayerdata = []
let user_match_data
let totalMoney

async function fetchData(NumberId) {
  try {
    const data = await $.ajax({
      url: `https://krinik.pythonanywhere.com/match_get/`,
      method: "GET"
    });
    const data1 = await $.ajax({
      url: `https://krinik.pythonanywhere.com/player_get/`,
      method: "GET"
    });
    const user_match = await $.ajax({
      url: `https://krinik.pythonanywhere.com/user_match_get/`,
      method: "GET"
    });
   
    
 teamData = data1.data
 console.log(teamData,"uio")
    let matchCheck = user_match.data
    console.log(matchCheck,"dataCheck");
    

    if (data && data.status === "success") {
      console.log(data.data);
      console.log(NumberId, "fit");

      // Log all IDs in the response data
    if(matchCheck.length > 0){
      user_match_data = matchCheck.filter((p) => p.match.id === NumberId )
      
    }
    console.log(user_match_data,"user_match_data")

    totalMoney = user_match_data.reduce((accumulator, userMatch) => {
        return userMatch.total_amount + accumulator;
      }, 0);
      console.log("Total Money:", totalMoney);

      // Compare the values directly
      let filtermatchview = data.data.find((p) => p.id === NumberId);
      matchName = filtermatchview.match_display_name
      console.log(filtermatchview,"matchName")
      let Players1 = filtermatchview.select_player_A.map((p)=>p)
      let Players2 = filtermatchview.select_player_B.map((p)=>p)

      let AllPlayers = [...Players1,...Players2]
      console.log(AllPlayers,"Allplayers")

      let Players12 = filtermatchview.player_list
      
      if (filtermatchview) {
        let filteredPlayers = Players12
   .filter(playerId => AllPlayers.some(player => player.id === playerId)) // Check if playerId exists in AllPlayers
   .map(playerId => teamData.find(player => player.id === playerId)); // Map to actual player data from teamData
 // Map to actual player data from teamData

        console.log(filteredPlayers, "Filtered team players (Order matches Players12)");
        let sortfiltereplayers = [...new Set(filteredPlayers)]
        // Now, you can use this filtered data
        rankList = sortfiltereplayers;

        array = rankList;
        filterAndDisplay();
      } else {
        console.error("No match found for the given ID.");
      }
    } else {
      console.error("Error: Invalid data format");
    }
  } catch (error) {
    console.error("Error fetching data", error);
  }
}


function filterAndDisplay() {
  // filterRankList();
  preLoadCalculations();
  displayIndexButtons();
  displayTableRows();
  highlightIndexButton();
  
}

function preLoadCalculations(filteredArrayLength) {
  array_length = filteredArrayLength || array.length;
  max_index = Math.ceil(array_length / table_size);
}

function filterRankList() {
    // var tab_filter_text = $("#tab_filter_text").val().toLowerCase().trim();
    // var datefilter = $('#rangePicker').text().trim();
    // const statusFilter = $("#selectedStatus").data('value') || '';
    // var startDate, endDate;

    // if (datefilter !== '' && datefilter !== 'Start & End Date') {
    //     var dates = datefilter.split(' - ');
    //     startDate = moment(dates[0], 'DD-MM-YYYY').toDate();
    //     console.log(startDate)
    //     endDate = moment(dates[1], 'DD-MM-YYYY').toDate();
    // }

    // var filteredArray = rankList.filter(function (object) {
    //     var matchesText = true, matchesStatus = true, matchesDate = true;

        // if (tab_filter_text !== '') {
        //     matchesText = (object.league_name && object.league_name.toLowerCase().includes(tab_filter_text)) ||
        //         (object.short_league_name && object.short_league_name.toLowerCase().includes(tab_filter_text)) ||
        //         (object.start_league_date && object.start_league_date.toLowerCase().includes(tab_filter_text)) ||
        //         (object.end_league_date && object.end_league_date.toLowerCase().includes(tab_filter_text));
        // }

        // if (statusFilter !== '') {
        //     const status = getStatus(object.start_league_date, object.end_league_date);
        //     matchesStatus = (status === statusFilter);
        // }
  //       if (statusFilter !== 'All Status') {
  //         const status = getStatus(object.start_league_date, object.end_league_date)
  //   console.log(status)
  //   matchesStatus = (status === statusFilter);
  //   // console.log(matchesStatus ,"okli")
  // }

    //     if (startDate && endDate) {
    //         matchesDate = (moment(object.start_league_date, 'DD-MM-YYYY').toDate() >= startDate &&
    //             moment(object.end_league_date, 'DD-MM-YYYY').toDate() <= endDate);
    //     }

    //     return matchesText && matchesStatus && matchesDate;
    // });

    array = filteredArray;
    preLoadCalculations();
    current_index = 1;
    displayIndexButtons();
    highlightIndexButton()
    displayTableRows();
}



function displayIndexButtons() {
$(".index_buttons ul").empty();

if (array_length <= table_size) {
    // If there are 10 or fewer items, do not show pagination
    return;
}

if (current_index > 1) {
    $(".index_buttons ul").append('<li><button class="paginate_button page-item previous" onclick="prev()">Previous</button></li>');
}

const show_page = getElidedPageRange(current_index, max_index);

show_page.forEach(i => {
    if (i === current_index) {
        $(".index_buttons ul").append('<li><button class="paginate_button page-item active">' + i + '</button></li>');
    } else if (i === "...") {
        $(".index_buttons ul").append('<li><button class="paginate_button page-item">...</button></li>');
    } else {
        $(".index_buttons ul").append('<li><button class="paginate_button page-item" onclick="indexPagination(' + i + ')">' + i + '</button></li>');
    }
});

if (current_index < max_index) {
    $(".index_buttons ul").append('<li><button class="paginate_button page-item next" onclick="next()">Next</button></li>');
}

highlightIndexButton();
}


function getElidedPageRange(current, total) {
    const delta = 1;
    const range = [];
    const left = current - delta;
    const right = current + delta + 1;
    let last = 0;

    for (let i = 1; i <= total; i++) {
        if (i === 1 || i === total || (i >= left && i < right)) {
            if (last + 1 !== i) {
                range.push("...");
            }
            range.push(i);
            last = i;
        }
    }

    return range;
}

function highlightIndexButton() {
    start_index = (current_index - 1) * table_size + 1;
    end_index = Math.min(start_index + table_size - 1, array_length);
    $("#datatable_info").text("Showing " + start_index + " to " + end_index + " of " + array_length + " items");
    $(".index_buttons ul a").removeClass("active");
    $('.index_buttons ul a').each(function () {
        if ($(this).text() == current_index) {
            $(this).addClass("active");
        }
    });
    displayTableRows();
}
function prev() {
    if (current_index > 1) {
        current_index--;
        displayIndexButtons();
        highlightIndexButton();
    }
}

function next() {
    if (current_index < max_index) {
        current_index++;
        displayIndexButtons();
        highlightIndexButton();
    }
}

function indexPagination(index) {
    current_index = index;
    displayIndexButtons();
    highlightIndexButton();
}


function displayTableRows() {
  $("table tbody").empty();
  var tab_start = start_index - 1;
  var tab_end = end_index;

  if (array.length === 0) {
    $("#noDataFound").show();
    $("#pagination").hide();
    $("#table-scrolling").css("overflow-x", "hidden");
    return;
  } else {
    $("#noDataFound").hide();
    $("#pagination").show();
    $("#table-scrolling").css("overflow-x", "auto");
  }

  // Loop through the array for the specified range
  for (var i = tab_start; i < tab_end && i < array.length; i++) {
    var showdata = array[i];

    console.log(showdata, "showData");

    var tr = $("<tr></tr>")
      .attr("data-player-id", showdata["id"]) // Store playerId in a data attribute
      .attr("data-match-id", showdata["team_name"].id); // Store matchId in a data attribute

    var noCell = $("<td></td>").text(i + 1);
    var fullNameCell = $("<td colspan='2'></td>").text(showdata["player_name"] || "");
    var shortNameCell = $("<td colspan='2'></td>").text(showdata["team_name"].team_name || "");

    // Use .html() to properly render the input element
    var enterRun = $("<td class='responsive-td'></td>").html("<input type='text' placeholder='Enter Run' class='run-input p-2 text-center'>");

    tr.append(noCell)
      .append(fullNameCell)
      .append(shortNameCell)
      .append(enterRun);

    $("table tbody").append(tr);
  }
}

// Function to post run data and redirect
// Function to post run data and redirect
// Function to post run data and update total_run in player_get
async function postRunData() {
  // Array to hold player data objects
  var dataToPost = [];
  // var totalMatchScore = 0;

  // Loop through all the rows in the table
  $("table tbody tr").each(function() {
    // Get the run value and convert it to a number
    var runValue = $(this).find(".run-input").val();
    runValue = runValue ? Number(runValue) : 0; // Convert to number

    // Get playerId and matchId from the data attributes
    var playerId = $(this).data("player-id");
    var matchId = $(this).data("match-id");

    // Create player data object with playerId and matchId
    var playerData = {
      player_declare: playerId,  // Use playerId instead of playerName
      team_declare: matchId,     // Use matchId instead of teamName
      total_run: runValue,
      select_match: matchName    // Use matchName as it is
    };
    var playerData1 = {
      player_id: playerId,  // Use playerId instead of playerName
          // Use matchId instead of teamName
      run: runValue,
         // Use matchName as it is
    };

    // Push the playerData to the array
    dataToPost.push(playerData);
    userplayerdata.push(playerData1)
  });

  // console.log(dataToPost, "dataPost");

  // Send each player data object individually to the API
  dataToPost.forEach(function(data) {
    // POST request to submit the run data to the pool_declare endpoint
    $.ajax({
      url: 'https://krinik.pythonanywhere.com/pool_declare/', // Replace with your API endpoint
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data), // Convert the playerData object to JSON string

      success: function(response) {
        // console.log("Data posted successfully for", data.player_declare, response);
      },
      error: function(error) {
        console.error("Error posting data for", data.player_declare, error);
        alert("Failed to submit run data for " + data.player_declare + ".");
      }
    });

    // First, get the current total_run value from the player_get endpoint
    $.ajax({
  url: `https://krinik.pythonanywhere.com/player_get/${data.player_declare}/`, // Use playerId to fetch the player's current total_run
  type: 'GET',
  success: function(response) {
    console.log(response,"olp")
    // Check if the total_run is present in the response and log it
    if (response && typeof response.data.total_run == 'number') {
      var currentRun = response.data.total_run; // Get the current total_run from the API response
      console.log("Current total_run from API for player", data.player_declare, ":", currentRun);

      // Add the new run value to the existing total_run
      var updatedRun = currentRun + data.total_run;
      console.log("Updated total_run (current + new):", updatedRun);

      // PATCH request to update the total_run field with the new value
      $.ajax({
        url: `https://krinik.pythonanywhere.com/player_get/${data.player_declare}/`, // Use playerId to update the player's total_run
        type: 'PATCH',
        contentType: 'application/json',
        data: JSON.stringify({
          total_run: updatedRun // Send the updated total_run value
        }),
        success: function(patchResponse) {
          console.log("Total run updated successfully for player", data.player_declare, patchResponse);
        },
        error: function(patchError) {
          console.error("Error updating total run for player", data.player_declare, patchError);
          alert("Failed to update total run for " + data.player_declare + ".");
        }
      });
    } else {
      console.error("Error: total_run is not present or invalid in the API response for player", data.player_declare);
    }
  },
  error: function(getError) {
    console.error("Error fetching current total run for player", data.player_declare, getError);
    alert("Failed to fetch current total run for " + data.player_declare + ".");
  }
});

  });

  let matchScores = []; // Array to store match scores

// Use Promise.all to handle asynchronous operations in the forEach loop
const matchPromises = user_match_data.map(async (match) => {
    let totalMatchScore = 0;  // Reset totalMatchScore for each match

    // Loop through match players
    match.player.forEach(player => {
        // Find the corresponding player in userplayerdata using player_id
        const matchedPlayer = userplayerdata.find(p => p.player_id === player.id);

        if (matchedPlayer) {
            // If the player is found, get their run, default to 0 if not available
            const playerRun = matchedPlayer.run || 0;
            console.log(playerRun, "player");
            let finalRun = playerRun;

            // Adjust player run based on captain and vice-captain conditions
            if (player.match_captain) {
                finalRun = playerRun * 2;  // Double the run if the player is the captain
            } else if (player.match_vice_captain) {
                finalRun = playerRun * 1.5;  // 1.5x the run if the player is the vice-captain
            }

            // Add the adjusted run to totalMatchScore
            totalMatchScore += finalRun;
        }
    });

    // Output total match score for debugging
    console.log(`Total Match Score for match ${match.id}:`, totalMatchScore);

    // Store the total score for each match
    matchScores.push({
        matchId: match.id,
        pool_name: match.pool_name,
        score: totalMatchScore
    });
    console.log(matchScores, "matchScores");

    // PATCH the total match score to the API for each match
    try {
        await $.ajax({
            url: `https://krinik.pythonanywhere.com/user_match_get/${match.id}`,  // Use match ID for updating
            type: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({
                score: totalMatchScore  // Send the calculated total score
            }),
            success: function(response) {
                console.log(`Total match score updated successfully for match ${match.id}`, response);
            },
            error: function(error) {  // Error handling for the AJAX call
                console.error(`Error updating match score for match ${match.id}:`, error);
            }
        });
    } catch (error) {
        console.error(`Failed to update score for match ${match.id}:`, error);
    }
});

// Wait for all match score calculations and PATCH requests to complete
Promise.all(matchPromises).then(() => {
    // Group match scores by pool_name
    const groupedScores = matchScores.reduce((acc, match) => {
        // If the pool_name does not exist in the accumulator, create an array for it
        if (!acc[match.pool_name]) {
            acc[match.pool_name] = [];
        }
        // Add the match to the corresponding pool_name group
        acc[match.pool_name].push(match);
        return acc;
    }, {});

    console.log(groupedScores, "Grouped Scores by Pool");

    // Iterate over each pool group to calculate the highest score and update the winning status
    Object.keys(groupedScores).forEach(poolName => {
        const poolMatches = groupedScores[poolName];

        // Find the highest score in the current pool
        const maxScore = Math.max(...poolMatches.map(match => match.score));

        // Update the winning status for each match in the pool
        poolMatches.forEach(async (match) => {
            let winningStatus = match.score === maxScore ? "Winner" : "Contestant"; // Determine winner based on maxScore

            // PATCH the winning status to the API for each match
            try {
                await $.ajax({
                    url: `https://krinik.pythonanywhere.com/user_match_get/${match.matchId}`,  // Use match ID for updating
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        winning_status: winningStatus  // Send the winning status
                    }),
                    success: function(response) {
                        console.log(`Winning status updated successfully for match ${match.matchId}`, response);
                    },
                    error: function(error) {
                        console.error(`Error updating winning status for match ${match.matchId}:`, error);
                    }
                });
            } catch (error) {
                console.error(`Failed to update winning status for match ${match.matchId}:`, error);
            }
        });
    });
}).catch(error => {
    console.error('Error in processing matches:', error);
});

    // Next, POST individual player scores in players_score
    user_match_data.forEach((match) => {
    const players_score = [];

    // Loop through the players in the match
    match.player.forEach((player) => {
        // Find the corresponding player in userplayerdata using player_id
        const matchedPlayer = userplayerdata.find(p => p.player_id === player.id);

        if (matchedPlayer) {
            // Push the matched player data to the players_score array
            players_score.push(matchedPlayer);
        }
    });

    // Prepare data without checking players_score length
    const updatedData = {
        players_score: players_score  // Set players_score with the filtered players
    };

    // Send a PATCH request to update the players_score field
    $.ajax({
        url: `https://krinik.pythonanywhere.com/user_match_get/${match.id}`, // API endpoint with match ID
        type: 'PATCH',
        contentType: 'application/json',
        data: JSON.stringify(updatedData), // Send only the players_score field as an array
        success: function(response) {
            console.log("Player scores posted successfully for match", match.id, response);
        },
        error: function(error) {
            console.error("Error posting player scores for match", match.id, error);
            alert("Failed to submit player scores for match " + match.id + ".");
        }
    });
});



    // Optionally redirect after submitting
  // window.location.href = "match-name.html";
}


// Set up the click event handler for the submit button
$(document).ready(function() {
  $("#submitButton").on("click", function() {
    postRunData(); // Call the function to post data
  });
});



fetchData(NumberId);

</script>



</body>

</html>